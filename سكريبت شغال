import telebot
import os
import subprocess
import threading
import uuid
import time
import requests
import signal

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ
font_url = "https://github.com/googlefonts/noto-fonts/raw/main/hinted/ttf/NotoNaskhArabic/NotoNaskhArabic-Regular.ttf"
font_path = "/root/.fonts/NotoNaskhArabic-Regular.ttf"
os.makedirs("/root/.fonts", exist_ok=True)
if not os.path.exists(font_path):
    with open(font_path, "wb") as f:
        f.write(requests.get(font_url).content)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆÙƒÙ†
TOKEN = 'Ø¶Ø¹_ØªÙˆÙƒÙ†_Ø§Ù„Ø¨ÙˆØª_Ù‡Ù†Ø§'
bot = telebot.TeleBot(TOKEN)

# Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
ADMIN_ID = 123456789  # â† ØºÙŠÙ‘Ø±Ù‡ Ø¥Ù„Ù‰ Ù…Ø¹Ø±ÙÙƒ

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
def load_subscribers():
    if not os.path.exists("subscribers.txt"):
        return set()
    with open("subscribers.txt", "r") as f:
        return set(int(line.strip()) for line in f if line.strip().isdigit())

def save_subscriber(user_id):
    subscribers.add(user_id)
    with open("subscribers.txt", "a") as f:
        f.write(f"{user_id}\n")

subscribers = load_subscribers()
streams = {}  # {chat_id: {id, m3u8, fb_key, text_path, process}}

# Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
@bot.message_handler(commands=['start'])
def start(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row("ğŸ¬ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨Ø«", "ğŸ“ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¨Ø«")
    markup.row("âŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø³Ù…", "â›” Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«")
    bot.send_message(message.chat.id, "Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹\nØ§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ù‡:", reply_markup=markup)

# Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ
@bot.message_handler(commands=['addsub'])
def add_subscriber(message):
    if message.chat.id != ADMIN_ID:
        return bot.send_message(message.chat.id, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·.")
    bot.send_message(message.chat.id, "ğŸ“¨ Ø£Ø±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:")
    bot.register_next_step_handler(message, process_add_sub)

def process_add_sub(message):
    try:
        user_id = int(message.text.strip())
        if user_id in subscribers:
            bot.send_message(message.chat.id, "âœ… Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.")
        else:
            save_subscriber(user_id)
            bot.send_message(message.chat.id, f"âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©: {user_id}")
    except:
        bot.send_message(message.chat.id, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø±Ù‚Ù…ÙŠ ØµØ­ÙŠØ­.")

# ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨Ø«
@bot.message_handler(func=lambda m: m.text == "ğŸ¬ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨Ø«")
def prepare_stream(message):
    if message.chat.id not in subscribers and message.chat.id != ADMIN_ID:
        return bot.send_message(message.chat.id, "âŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙ‚Ø·.")
    if message.chat.id in streams and 'process' in streams[message.chat.id]:
        return bot.send_message(message.chat.id, "âš ï¸ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„. Ø£ÙˆÙ‚ÙÙ‡ Ø£ÙˆÙ„Ù‹Ø§.")
    bot.send_message(message.chat.id, "ğŸ”— Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· m3u8:")
    bot.register_next_step_handler(message, get_m3u8)

def get_m3u8(message):
    streams[message.chat.id] = {}
    streams[message.chat.id]['m3u8'] = message.text
    bot.send_message(message.chat.id, "ğŸ¥ Ø£Ø±Ø³Ù„ Ù…ÙØªØ§Ø­ Facebook Live:")
    bot.register_next_step_handler(message, get_key)

def get_key(message):
    chat_id = message.chat.id
    key = message.text
    stream_id = str(uuid.uuid4())[:8]
    text_path = f"text_{stream_id}.txt"

    streams[chat_id].update({
        'fb_key': key,
        'id': stream_id,
        'text_path': text_path
    })

    with open(text_path, 'w') as f:
        f.write('')

    thread = threading.Thread(target=start_stream, args=(chat_id,))
    thread.start()
    bot.send_message(chat_id, f"âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«.\nÙ…Ø¹Ø±Ù Ø§Ù„Ø¨Ø«: `{stream_id}`", parse_mode="Markdown")

# Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
def start_stream(chat_id):
    m3u8 = streams[chat_id]['m3u8']
    fb_key = streams[chat_id]['fb_key']
    text_path = streams[chat_id]['text_path']
    stream_id = streams[chat_id]['id']
    fb_url = f"rtmps://live-api-s.facebook.com:443/rtmp/{fb_key}"

    script = f"""
    while true
    do
        ffmpeg -re -i "{m3u8}" \\
        -vf "drawtext=fontfile=/root/.fonts/NotoNaskhArabic-Regular.ttf:textfile='{text_path}':reload=1:fontcolor=white:fontsize=36:x=(w-text_w)/2:y=20:box=1:boxcolor=black@0.5" \\
        -c:v libx264 -preset veryfast -maxrate 3000k -bufsize 6000k \\
        -c:a aac -b:a 128k -ar 44100 -ac 2 -f flv "{fb_url}"
        echo "ØªÙ… Ø§Ù„ØªÙˆÙ‚Ù... Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø®Ù„Ø§Ù„ 5 Ø«ÙˆØ§Ù†Ù"
        sleep 5
    done
    """

    script_path = f"run_{stream_id}.sh"
    with open(script_path, "w") as f:
        f.write(script)
    os.chmod(script_path, 0o755)

    process = subprocess.Popen(["bash", script_path], preexec_fn=os.setsid)
    streams[chat_id]['process'] = process

# ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
@bot.message_handler(func=lambda m: m.text == "ğŸ“ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø¨Ø«")
def ask_for_name(message):
    bot.send_message(message.chat.id, "âœï¸ Ø£Ø±Ø³Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
    bot.register_next_step_handler(message, set_name)

def set_name(message):
    chat_id = message.chat.id
    if chat_id not in streams:
        return bot.send_message(chat_id, "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ø¬Ø§Ø±ÙŠ.")
    path = streams[chat_id]['text_path']
    with open(path, 'w') as f:
        f.write(message.text)
    bot.send_message(chat_id, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù….")

# Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø³Ù…
@bot.message_handler(func=lambda m: m.text == "âŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø³Ù…")
def ask_for_id(message):
    bot.send_message(message.chat.id, "ğŸ†” Ø£Ø±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¨Ø«:")
    bot.register_next_step_handler(message, remove_name)

def remove_name(message):
    stream_id = message.text.strip()
    for chat_id, data in streams.items():
        if data.get('id') == stream_id:
            with open(data['text_path'], 'w') as f:
                f.write('')
            bot.send_message(chat_id, "âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.")
            return
    bot.send_message(message.chat.id, "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ù…Ø·Ø§Ø¨Ù‚.")

# Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
@bot.message_handler(func=lambda m: m.text == "â›” Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«")
def stop_stream(message):
    chat_id = message.chat.id
    if chat_id in streams and 'process' in streams[chat_id]:
        process = streams[chat_id]['process']
        try:
            os.killpg(os.getpgid(process.pid), signal.SIGTERM)
        except Exception as e:
            bot.send_message(chat_id, f"âš ï¸ ÙØ´Ù„ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«: {e}")
            return

        text_path = streams[chat_id]['text_path']
        script_path = f"run_{streams[chat_id]['id']}.sh"
        if os.path.exists(text_path):
            os.remove(text_path)
        if os.path.exists(script_path):
            os.remove(script_path)

        del streams[chat_id]
        bot.send_message(chat_id, "ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­.")
    else:
        bot.send_message(chat_id, "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù†Ø´Ø·.")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot.polling()